name: Flutter CI

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version-file: pubspec.yaml

      - name: Install dependencies
        run: flutter pub get

      - name: Generate localization
        run: flutter gen-l10n

      - name: Generate code
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Enforce CI Guard Parity
        run: dart run tool/verify_ci_guard_parity.dart

      - name: Enforce Riverpod Annotation DI
        run: dart run tool/verify_riverpod_annotation.dart

      - name: Enforce State Management Contract
        run: dart run tool/verify_state_management_contract.dart

      - name: Enforce Navigation go_router Contract
        run: dart run tool/verify_navigation_go_router_contract.dart

      - name: Enforce Common Widget Boundaries
        run: dart run tool/verify_common_widget_boundaries.dart

      - name: Enforce UI Constants Centralization
        run: dart run tool/verify_ui_constants_centralization.dart

      - name: Enforce StringUtils Contract
        run: dart run tool/verify_string_utils_contract.dart

      - name: Enforce Theme Contract
        run: dart run tool/verify_theme_contract.dart

      - name: Enforce Accessibility Contract
        run: dart run tool/verify_accessibility_contract.dart

      - name: Enforce UI Design Guard
        run: dart run tool/verify_ui_design_guard.dart

      - name: Enforce UI State Scalability Contract
        run: dart run tool/verify_ui_state_scalability_contract.dart

      - name: Enforce Public API Test Contract
        run: dart run tool/verify_public_api_test_contract.dart

      - name: Enforce Test Pyramid Contract
        run: dart run tool/verify_test_pyramid_contract.dart

      - name: Enforce Code Quality Contract
        run: dart run tool/verify_code_quality_contract.dart

      - name: Run custom_lint gate
        run: dart run custom_lint

      - name: Analyze
        run: flutter analyze

      - name: Test With Coverage
        run: flutter test --coverage

      - name: Enforce Coverage Budget
        run: dart run tool/verify_coverage_budget.dart
